{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "storageAccounts_radfiles_name": {
            "defaultValue": "radfiles",
            "type": "String"
        },
        "batchAccounts_climatebasedbatch_name": {
            "defaultValue": "climatebasedbatch",
            "type": "String"
        },
        "pools_high_memory_name": {
            "defaultValue": "high_memory",
            "type": "String"
        },
        "pools_1st_deployment_name": {
            "defaultValue": "1st_deployment",
            "type": "String"
        }
    },
    "variables": {},
    "resources": [
        {
            "comments": "Generalized from resource: '/subscriptions/8cdf9a51-ec0e-4178-8206-6c98e47e7fc0/resourceGroups/batch_computing/providers/Microsoft.Batch/batchAccounts/climatebasedbatch'.",
            "type": "Microsoft.Batch/batchAccounts",
            "name": "[parameters('batchAccounts_climatebasedbatch_name')]",
            "apiVersion": "2017-09-01",
            "location": "westeurope",
            "scale": null,
            "properties": {
                "autoStorage": {
                    "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccounts_radfiles_name'))]"
                },
                "poolAllocationMode": "BatchService"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccounts_radfiles_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/8cdf9a51-ec0e-4178-8206-6c98e47e7fc0/resourceGroups/Batch_Computing/providers/Microsoft.Storage/storageAccounts/radfiles'.",
            "type": "Microsoft.Storage/storageAccounts",
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "kind": "Storage",
            "name": "[parameters('storageAccounts_radfiles_name')]",
            "apiVersion": "2018-02-01",
            "location": "westeurope",
            "tags": {},
            "scale": null,
            "properties": {
                "networkAcls": {
                    "bypass": "AzureServices",
                    "virtualNetworkRules": [],
                    "ipRules": [],
                    "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": false,
                "encryption": {
                    "services": {
                        "file": {
                            "enabled": true
                        },
                        "blob": {
                            "enabled": true
                        }
                    },
                    "keySource": "Microsoft.Storage"
                }
            },
            "dependsOn": []
        },
        {
            "comments": "Generalized from resource: '/subscriptions/8cdf9a51-ec0e-4178-8206-6c98e47e7fc0/resourceGroups/batch_computing/providers/Microsoft.Batch/batchAccounts/climatebasedbatch/pools/1st_deployment'.",
            "type": "Microsoft.Batch/batchAccounts/pools",
            "name": "[concat(parameters('batchAccounts_climatebasedbatch_name'), '/', parameters('pools_1st_deployment_name'))]",
            "apiVersion": "2017-09-01",
            "scale": null,
            "properties": {
                "vmSize": "BASIC_A1",
                "interNodeCommunication": "Disabled",
                "maxTasksPerNode": 1,
                "taskSchedulingPolicy": {
                    "nodeFillType": "Spread"
                },
                "deploymentConfiguration": {
                    "virtualMachineConfiguration": {
                        "imageReference": {
                            "publisher": "Canonical",
                            "offer": "UbuntuServer",
                            "sku": "16.04-LTS",
                            "version": "latest"
                        },
                        "nodeAgentSkuId": "batch.node.ubuntu 16.04"
                    }
                },
                "scaleSettings": {
                    "autoScale": {
                        "formula": "pendingTaskSamplePercent =$PendingTasks.GetSamplePercent(180 * TimeInterval_Second);pendingTaskSamples = pendingTaskSamplePercent < 70 ? 1 : avg($PendingTasks.GetSample(180 * TimeInterval_Second)); $TargetDedicatedNodes = min(100, pendingTaskSamples);",
                        "evaluationInterval": "PT5M"
                    }
                },
                "startTask": {
                    "commandLine": "/bin/bash -c 'set -e; set -o pipefail; cp -p copyToBlob.py $AZ_BATCH_NODE_SHARED_DIR;cp -p run_radiation.py $AZ_BATCH_NODE_SHARED_DIR;cp -p run_annual.py $AZ_BATCH_NODE_SHARED_DIR;cp -p run_daylight_factor.py $AZ_BATCH_NODE_SHARED_DIR;curl -fSsL https://bootstrap.pypa.io/get-pip.py | python;pip install azure-storage==0.32.0;sudo apt-get install docker -y && sudo apt-get install docker.io -y;sudo docker pull antoinedao/honeybee; wait'",
                    "resourceFiles": [
                        {
                            "blobSource": "[concat('https', '://', parameters('storageAccounts_radfiles_name'), '.blob.core.windows.net', '/application/run_radiation.py?se=2018-10-12T09%3A30%3A53Z&sp=r&sv=2017-07-29&sr=b&sig=QUnVXiu8VWGv%2BuxH85/3eqIiWcJIiNL1k0fjRa9FSYk%3D')]",
                            "filePath": "run_radiation.py"
                        },
                        {
                            "blobSource": "[concat('https', '://', parameters('storageAccounts_radfiles_name'), '.blob.core.windows.net', '/application/run_daylight_factor.py?se=2018-10-12T09%3A30%3A55Z&sp=r&sv=2017-07-29&sr=b&sig=nOGigYvV8EeaOsdU11IWh%2Bsav0K1LhPL4f5BThsjKLc%3D')]",
                            "filePath": "run_daylight_factor.py"
                        },
                        {
                            "blobSource": "[concat('https', '://', parameters('storageAccounts_radfiles_name'), '.blob.core.windows.net', '/application/run_annual.py?se=2018-10-12T09%3A30%3A55Z&sp=r&sv=2017-07-29&sr=b&sig=YbqCvNVEhfUy81ACBnq1m0yhTCyb3HQ9Ix1DEwZHdkE%3D')]",
                            "filePath": "run_annual.py"
                        },
                        {
                            "blobSource": "[concat('https', '://', parameters('storageAccounts_radfiles_name'), '.blob.core.windows.net', '/application/copyToBlob.py?se=2018-10-12T09%3A30%3A55Z&sp=r&sv=2017-07-29&sr=b&sig=/oFmjd39jd1mDGoimSoqofEdVt8Rec1Ym2bpZXdvh/4%3D')]",
                            "filePath": "copyToBlob.py"
                        }
                    ],
                    "userIdentity": {
                        "autoUser": {
                            "scope": "Pool",
                            "elevationLevel": "Admin"
                        }
                    },
                    "maxTaskRetryCount": 0,
                    "waitForSuccess": true
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Batch/batchAccounts', parameters('batchAccounts_climatebasedbatch_name'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccounts_radfiles_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/8cdf9a51-ec0e-4178-8206-6c98e47e7fc0/resourceGroups/batch_computing/providers/Microsoft.Batch/batchAccounts/climatebasedbatch/pools/high_memory'.",
            "type": "Microsoft.Batch/batchAccounts/pools",
            "name": "[concat(parameters('batchAccounts_climatebasedbatch_name'), '/', parameters('pools_high_memory_name'))]",
            "apiVersion": "2017-09-01",
            "scale": null,
            "properties": {
                "vmSize": "BASIC_A4",
                "interNodeCommunication": "Disabled",
                "maxTasksPerNode": 1,
                "taskSchedulingPolicy": {
                    "nodeFillType": "Spread"
                },
                "deploymentConfiguration": {
                    "virtualMachineConfiguration": {
                        "imageReference": {
                            "publisher": "Canonical",
                            "offer": "UbuntuServer",
                            "sku": "16.04-LTS",
                            "version": "latest"
                        },
                        "nodeAgentSkuId": "batch.node.ubuntu 16.04"
                    }
                },
                "scaleSettings": {
                    "autoScale": {
                        "formula": "pendingTaskSamplePercent =$PendingTasks.GetSamplePercent(180 * TimeInterval_Second);pendingTaskSamples = pendingTaskSamplePercent < 70 ? 1 : avg($PendingTasks.GetSample(180 * TimeInterval_Second)); $TargetDedicatedNodes = min(100, pendingTaskSamples);",
                        "evaluationInterval": "PT5M"
                    }
                },
                "startTask": {
                    "commandLine": "/bin/bash -c 'set -e; set -o pipefail; cp -p copyToBlob.py $AZ_BATCH_NODE_SHARED_DIR;cp -p run_radiation.py $AZ_BATCH_NODE_SHARED_DIR;cp -p run_annual.py $AZ_BATCH_NODE_SHARED_DIR;cp -p run_daylight_factor.py $AZ_BATCH_NODE_SHARED_DIR;curl -fSsL https://bootstrap.pypa.io/get-pip.py | python;pip install azure-storage==0.32.0;sudo apt-get install docker -y && sudo apt-get install docker.io -y;sudo docker pull antoinedao/honeybee; wait'",
                    "resourceFiles": [
                        {
                            "blobSource": "[concat('https', '://', parameters('storageAccounts_radfiles_name'), '.blob.core.windows.net', '/application/run_radiation.py?se=2018-09-24T17%3A15%3A49Z&sp=r&sv=2016-05-31&sr=b&sig=l81j%2BH6B0s8m5iFWLl4I5Hz659794NoQZgE7DGcAh3E%3D')]",
                            "filePath": "run_radiation.py"
                        },
                        {
                            "blobSource": "[concat('https', '://', parameters('storageAccounts_radfiles_name'), '.blob.core.windows.net', '/application/run_daylight_factor.py?se=2018-09-24T17%3A15%3A49Z&sp=r&sv=2016-05-31&sr=b&sig=AvYOrfRUcAE3GGF%2BABD8QEypNvaTMlDYOzC9JHDeuw4%3D')]",
                            "filePath": "run_daylight_factor.py"
                        },
                        {
                            "blobSource": "[concat('https', '://', parameters('storageAccounts_radfiles_name'), '.blob.core.windows.net', '/application/run_annual.py?se=2018-09-24T17%3A15%3A49Z&sp=r&sv=2016-05-31&sr=b&sig=e5nr/GDidjnwnnL0a1mf94y8g5nyaYjXP/F7RnJxruc%3D')]",
                            "filePath": "run_annual.py"
                        },
                        {
                            "blobSource": "[concat('https', '://', parameters('storageAccounts_radfiles_name'), '.blob.core.windows.net', '/application/copyToBlob.py?se=2018-09-24T17%3A15%3A49Z&sp=r&sv=2016-05-31&sr=b&sig=cXS5G7WVbuuecb1bUU28rj7JSMHO0RNHnC3vJJszrH8%3D')]",
                            "filePath": "copyToBlob.py"
                        }
                    ],
                    "userIdentity": {
                        "autoUser": {
                            "scope": "Pool",
                            "elevationLevel": "Admin"
                        }
                    },
                    "maxTaskRetryCount": 3,
                    "waitForSuccess": true
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Batch/batchAccounts', parameters('batchAccounts_climatebasedbatch_name'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccounts_radfiles_name'))]"
            ]
        }
    ]
}